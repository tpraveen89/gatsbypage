{"version":3,"sources":["../../src/query/query-runner.js"],"names":["fs","require","report","path","_","store","boundActionCreators","pageDataUtil","getCodeFrame","default","errorParser","resultHashes","Map","module","exports","graphqlRunner","queryJob","parentSpan","program","getState","graphql","query","context","queryName","promise","isPending","timeoutId","setTimeout","messageParts","componentPath","isPage","push","isEmpty","JSON","stringify","warn","join","finally","clearTimeout","result","id","errors","urlPath","undefined","queryContext","plugin","pluginCreatorId","structuredErrors","map","e","structuredError","message","codeFrame","locations","line","column","filePath","filter","Boolean","panicOnBuild","Object","assign","pageContext","internalComponentName","component","componentChunkName","updatedAt","pluginCreator___NODE","isCreatedByStatefulCreatePages","resultJSON","resultHash","createHash","update","digest","get","set","publicDir","directory","pages","page","write","resultPath","hash","outputFile","pageQueryRun","process","env","GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES","setPageData"],"mappings":"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","sourcesContent":["// @flow\n\nconst fs = require(`fs-extra`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\nconst path = require(`path`)\nconst _ = require(`lodash`)\nconst { store } = require(`../redux`)\nconst { boundActionCreators } = require(`../redux/actions`)\nconst pageDataUtil = require(`../utils/page-data`)\nconst { getCodeFrame } = require(`./graphql-errors`)\nconst { default: errorParser } = require(`./error-parser`)\n\nconst resultHashes = new Map()\n\ntype QueryJob = {\n  id: string,\n  hash?: string,\n  query: string,\n  componentPath: string,\n  context: Object,\n  isPage: Boolean,\n}\n\n// Run query\nmodule.exports = async (graphqlRunner, queryJob: QueryJob, { parentSpan }) => {\n  const { program } = store.getState()\n\n  const graphql = (query, context, queryName) => {\n    // Check if query takes too long, print out warning\n    const promise = graphqlRunner.query(query, context, {\n      parentSpan,\n      queryName,\n    })\n    let isPending = true\n\n    const timeoutId = setTimeout(() => {\n      if (isPending) {\n        const messageParts = [\n          `Query takes too long:`,\n          `File path: ${queryJob.componentPath}`,\n        ]\n\n        if (queryJob.isPage) {\n          const { path, context } = queryJob.context\n          messageParts.push(`URL path: ${path}`)\n\n          if (!_.isEmpty(context)) {\n            messageParts.push(`Context: ${JSON.stringify(context, null, 4)}`)\n          }\n        }\n\n        report.warn(messageParts.join(`\\n`))\n      }\n    }, 15000)\n\n    promise.finally(() => {\n      isPending = false\n      clearTimeout(timeoutId)\n    })\n\n    return promise\n  }\n\n  // Run query\n  let result\n  // Nothing to do if the query doesn't exist.\n  if (!queryJob.query || queryJob.query === ``) {\n    result = {}\n  } else {\n    result = await graphql(queryJob.query, queryJob.context, queryJob.id)\n  }\n\n  // If there's a graphql error then log the error. If we're building, also\n  // quit.\n  if (result && result.errors) {\n    let urlPath = undefined\n    let queryContext = {}\n    const plugin = queryJob.pluginCreatorId || `none`\n\n    if (queryJob.isPage) {\n      urlPath = queryJob.context.path\n      queryContext = queryJob.context.context\n    }\n\n    const structuredErrors = result.errors\n      .map(e => {\n        const structuredError = errorParser({\n          message: e.message,\n        })\n\n        structuredError.context = {\n          ...structuredError.context,\n          codeFrame: getCodeFrame(\n            queryJob.query,\n            e.locations && e.locations[0].line,\n            e.locations && e.locations[0].column\n          ),\n          filePath: queryJob.componentPath,\n          ...(urlPath && { urlPath }),\n          ...queryContext,\n          plugin,\n        }\n\n        return structuredError\n      })\n      .filter(Boolean)\n\n    report.panicOnBuild(structuredErrors)\n  }\n\n  // Add the page context onto the results.\n  if (queryJob && queryJob.isPage) {\n    result[`pageContext`] = Object.assign({}, queryJob.context)\n  }\n\n  // Delete internal data from pageContext\n  if (result.pageContext) {\n    delete result.pageContext.path\n    delete result.pageContext.internalComponentName\n    delete result.pageContext.component\n    delete result.pageContext.componentChunkName\n    delete result.pageContext.updatedAt\n    delete result.pageContext.pluginCreator___NODE\n    delete result.pageContext.pluginCreatorId\n    delete result.pageContext.componentPath\n    delete result.pageContext.context\n    delete result.pageContext.isCreatedByStatefulCreatePages\n  }\n\n  const resultJSON = JSON.stringify(result)\n  const resultHash = require(`crypto`)\n    .createHash(`sha1`)\n    .update(resultJSON)\n    .digest(`base64`)\n  if (resultHash !== resultHashes.get(queryJob.id)) {\n    resultHashes.set(queryJob.id, resultHash)\n\n    if (queryJob.isPage) {\n      const publicDir = path.join(program.directory, `public`)\n      const { pages } = store.getState()\n      const page = pages.get(queryJob.id)\n      await pageDataUtil.write({ publicDir }, page, result)\n    } else {\n      // The babel plugin is hard-coded to load static queries from\n      // public/static/d/\n      const resultPath = path.join(\n        program.directory,\n        `public`,\n        `static`,\n        `d`,\n        `${queryJob.hash}.json`\n      )\n      await fs.outputFile(resultPath, resultJSON)\n    }\n  }\n\n  boundActionCreators.pageQueryRun({\n    path: queryJob.id,\n    componentPath: queryJob.componentPath,\n    isPage: queryJob.isPage,\n  })\n\n  // Sets pageData to the store, here for easier access to the resultHash\n  if (\n    process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES &&\n    queryJob.isPage\n  ) {\n    boundActionCreators.setPageData({\n      id: queryJob.id,\n      resultHash,\n    })\n  }\n  return result\n}\n"],"file":"query-runner.js"}