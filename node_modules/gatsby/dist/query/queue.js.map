{"version":3,"sources":["../../src/query/queue.js"],"names":["Queue","require","store","FastMemoryStore","queryRunner","websocketManager","GraphQLRunner","default","createBaseOptions","concurrent","Number","process","env","GATSBY_EXPERIMENTAL_QUERY_CONCURRENCY","createBuildQueue","graphqlRunner","runnerOptions","handler","job","activity","callback","parentSpan","span","then","result","catch","queue","createDevelopQueue","getRunner","queueOptions","priority","cb","id","activePaths","has","merge","oldTask","newTask","queryJob","isPage","emitPageData","emitStaticQueryData","error","processBatch","jobs","length","Promise","resolve","reject","taskFinishCallback","tick","on","taskFailedCallback","err","gc","drainCallback","off","forEach","push","module","exports"],"mappings":";;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAE,cAAF,CAArB;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAYD,OAAO,CAAE,UAAF,CAAzB;;AACA,MAAME,eAAe,GAAGF,OAAO,CAAE,oCAAF,CAA/B;;AACA,MAAMG,WAAW,GAAGH,OAAO,CAAE,uBAAF,CAA3B;;AACA,MAAM;AAAEI,EAAAA;AAAF,IAAuBJ,OAAO,CAAE,4BAAF,CAApC;;AACA,MAAMK,aAAa,GAAGL,OAAO,CAAE,kBAAF,CAAP,CAA4BM,OAAlD;;AAEA,MAAMC,iBAAiB,GAAG,MAAM;AAC9B,SAAO;AACLC,IAAAA,UAAU,EAAEC,MAAM,CAACC,OAAO,CAACC,GAAR,CAAYC,qCAAb,CAAN,IAA6D,CADpE;AAEL;AACAX,IAAAA,KAAK,EAAEC,eAAe;AAHjB,GAAP;AAKD,CAND;;AAQA,MAAMW,gBAAgB,GAAG,CAACC,aAAD,EAAgBC,aAAa,GAAG,EAAhC,KAAuC;AAC9D,MAAI,CAACD,aAAL,EAAoB;AAClBA,IAAAA,aAAa,GAAG,IAAIT,aAAJ,CAAkBJ,KAAlB,EAAyBc,aAAzB,CAAhB;AACD;;AACD,QAAMC,OAAO,GAAG,CAAC;AAAEC,IAAAA,GAAF;AAAOC,IAAAA;AAAP,GAAD,EAAoBC,QAApB,KACdhB,WAAW,CAACW,aAAD,EAAgBG,GAAhB,EAAqB;AAAEG,IAAAA,UAAU,EAAEF,QAAF,aAAEA,QAAF,uBAAEA,QAAQ,CAAEG;AAAxB,GAArB,CAAX,CACGC,IADH,CACQC,MAAM,IAAIJ,QAAQ,CAAC,IAAD,EAAOI,MAAP,CAD1B,EAEGC,KAFH,CAESL,QAFT,CADF;;AAIA,QAAMM,KAAK,GAAG,IAAI1B,KAAJ,CAAUiB,OAAV,EAAmBT,iBAAiB,EAApC,CAAd;AACA,SAAOkB,KAAP;AACD,CAVD;;AAYA,MAAMC,kBAAkB,GAAGC,SAAS,IAAI;AACtC,QAAMC,YAAY,GAAG,EACnB,GAAGrB,iBAAiB,EADD;AAEnBsB,IAAAA,QAAQ,EAAE,CAAC;AAAEZ,MAAAA;AAAF,KAAD,EAAUa,EAAV,KAAiB;AACzB,UAAIb,GAAG,CAACc,EAAJ,IAAU3B,gBAAgB,CAAC4B,WAAjB,CAA6BC,GAA7B,CAAiChB,GAAG,CAACc,EAArC,CAAd,EAAwD;AACtDD,QAAAA,EAAE,CAAC,IAAD,EAAO,EAAP,CAAF;AACD,OAFD,MAEO;AACLA,QAAAA,EAAE,CAAC,IAAD,EAAO,CAAP,CAAF;AACD;AACF,KARkB;AASnBI,IAAAA,KAAK,EAAE,CAACC,OAAD,EAAUC,OAAV,EAAmBN,EAAnB,KAA0B;AAC/BA,MAAAA,EAAE,CAAC,IAAD,EAAOM,OAAP,CAAF;AACD;AAXkB,GAArB;;AAcA,QAAMpB,OAAO,GAAG,CAAC;AAAEC,IAAAA,GAAG,EAAEoB,QAAP;AAAiBnB,IAAAA;AAAjB,GAAD,EAA8BC,QAA9B,KAA2C;AACzDhB,IAAAA,WAAW,CAACwB,SAAS,EAAV,EAAcU,QAAd,EAAwB;AAAEjB,MAAAA,UAAU,EAAEF,QAAF,aAAEA,QAAF,uBAAEA,QAAQ,CAAEG;AAAxB,KAAxB,CAAX,CAAmEC,IAAnE,CACEC,MAAM,IAAI;AACR,UAAIc,QAAQ,CAACC,MAAb,EAAqB;AACnBlC,QAAAA,gBAAgB,CAACmC,YAAjB,CAA8B;AAC5BhB,UAAAA,MAD4B;AAE5BQ,UAAAA,EAAE,EAAEM,QAAQ,CAACN;AAFe,SAA9B;AAID,OALD,MAKO;AACL3B,QAAAA,gBAAgB,CAACoC,mBAAjB,CAAqC;AACnCjB,UAAAA,MADmC;AAEnCQ,UAAAA,EAAE,EAAEM,QAAQ,CAACN;AAFsB,SAArC;AAID;;AAEDZ,MAAAA,QAAQ,CAAC,IAAD,EAAOI,MAAP,CAAR;AACD,KAfH,EAgBEkB,KAAK,IAAItB,QAAQ,CAACsB,KAAD,CAhBnB;AAkBD,GAnBD;;AAqBA,SAAO,IAAI1C,KAAJ,CAAUiB,OAAV,EAAmBY,YAAnB,CAAP;AACD,CArCD;AAuCA;;;;;;;;AAMA,MAAMc,YAAY,GAAG,OAAOjB,KAAP,EAAckB,IAAd,EAAoBzB,QAApB,KAAiC;AACpD,MAAIyB,IAAI,CAACC,MAAL,KAAgB,CAApB,EAAuB;AACrB,WAAOC,OAAO,CAACC,OAAR,EAAP;AACD;;AAED,SAAO,IAAID,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,QAAIC,kBAAJ;;AACA,QAAI9B,QAAQ,CAAC+B,IAAb,EAAmB;AACjBD,MAAAA,kBAAkB,GAAG,MAAM9B,QAAQ,CAAC+B,IAAT,EAA3B;;AACAxB,MAAAA,KAAK,CAACyB,EAAN,CAAU,aAAV,EAAwBF,kBAAxB;AACD;;AAED,UAAMG,kBAAkB,GAAG,CAAC,GAAGC,GAAJ,KAAY;AACrCC,MAAAA,EAAE;AACFN,MAAAA,MAAM,CAACK,GAAD,CAAN;AACD,KAHD;;AAKA,UAAME,aAAa,GAAG,MAAM;AAC1BD,MAAAA,EAAE;AACFP,MAAAA,OAAO;AACR,KAHD;;AAKA,UAAMO,EAAE,GAAG,MAAM;AACf5B,MAAAA,KAAK,CAAC8B,GAAN,CAAW,aAAX,EAAyBJ,kBAAzB;AACA1B,MAAAA,KAAK,CAAC8B,GAAN,CAAW,OAAX,EAAmBD,aAAnB;;AACA,UAAIN,kBAAJ,EAAwB;AACtBvB,QAAAA,KAAK,CAAC8B,GAAN,CAAW,aAAX,EAAyBP,kBAAzB;AACD;;AACDvB,MAAAA,KAAK,GAAG,IAAR;AACD,KAPD;;AASAA,IAAAA,KAAK,CACH;AADG,KAEFyB,EAFH,CAEO,aAFP,EAEqBC,kBAFrB,EAGE;AACA;AAJF,KAKGD,EALH,CAKO,OALP,EAKeI,aALf;AAOAX,IAAAA,IAAI,CAACa,OAAL,CAAavC,GAAG,IACdQ,KAAK,CAACgC,IAAN,CAAW;AACTxC,MAAAA,GADS;AAETC,MAAAA;AAFS,KAAX,CADF;AAMD,GAvCM,CAAP;AAwCD,CA7CD;;AA+CAwC,MAAM,CAACC,OAAP,GAAiB;AACf9C,EAAAA,gBADe;AAEfa,EAAAA,kBAFe;AAGfgB,EAAAA;AAHe,CAAjB","sourcesContent":["const Queue = require(`better-queue`)\nconst { store } = require(`../redux`)\nconst FastMemoryStore = require(`../query/better-queue-custom-store`)\nconst queryRunner = require(`../query/query-runner`)\nconst { websocketManager } = require(`../utils/websocket-manager`)\nconst GraphQLRunner = require(`./graphql-runner`).default\n\nconst createBaseOptions = () => {\n  return {\n    concurrent: Number(process.env.GATSBY_EXPERIMENTAL_QUERY_CONCURRENCY) || 4,\n    // eslint-disable-next-line new-cap\n    store: FastMemoryStore(),\n  }\n}\n\nconst createBuildQueue = (graphqlRunner, runnerOptions = {}) => {\n  if (!graphqlRunner) {\n    graphqlRunner = new GraphQLRunner(store, runnerOptions)\n  }\n  const handler = ({ job, activity }, callback) =>\n    queryRunner(graphqlRunner, job, { parentSpan: activity?.span })\n      .then(result => callback(null, result))\n      .catch(callback)\n  const queue = new Queue(handler, createBaseOptions())\n  return queue\n}\n\nconst createDevelopQueue = getRunner => {\n  const queueOptions = {\n    ...createBaseOptions(),\n    priority: ({ job }, cb) => {\n      if (job.id && websocketManager.activePaths.has(job.id)) {\n        cb(null, 10)\n      } else {\n        cb(null, 1)\n      }\n    },\n    merge: (oldTask, newTask, cb) => {\n      cb(null, newTask)\n    },\n  }\n\n  const handler = ({ job: queryJob, activity }, callback) => {\n    queryRunner(getRunner(), queryJob, { parentSpan: activity?.span }).then(\n      result => {\n        if (queryJob.isPage) {\n          websocketManager.emitPageData({\n            result,\n            id: queryJob.id,\n          })\n        } else {\n          websocketManager.emitStaticQueryData({\n            result,\n            id: queryJob.id,\n          })\n        }\n\n        callback(null, result)\n      },\n      error => callback(error)\n    )\n  }\n\n  return new Queue(handler, queueOptions)\n}\n\n/**\n * Returns a promise that pushes jobs onto queue and resolves onces\n * they're all finished processing (or rejects if one or more jobs\n * fail)\n * Note: queue is reused in develop so make sure to thoroughly cleanup hooks\n */\nconst processBatch = async (queue, jobs, activity) => {\n  if (jobs.length === 0) {\n    return Promise.resolve()\n  }\n\n  return new Promise((resolve, reject) => {\n    let taskFinishCallback\n    if (activity.tick) {\n      taskFinishCallback = () => activity.tick()\n      queue.on(`task_finish`, taskFinishCallback)\n    }\n\n    const taskFailedCallback = (...err) => {\n      gc()\n      reject(err)\n    }\n\n    const drainCallback = () => {\n      gc()\n      resolve()\n    }\n\n    const gc = () => {\n      queue.off(`task_failed`, taskFailedCallback)\n      queue.off(`drain`, drainCallback)\n      if (taskFinishCallback) {\n        queue.off(`task_finish`, taskFinishCallback)\n      }\n      queue = null\n    }\n\n    queue\n      // Note: the first arg is the path, the second the error\n      .on(`task_failed`, taskFailedCallback)\n      // Note: `drain` fires when all tasks _finish_\n      //       `empty` fires when queue is empty (but tasks are still running)\n      .on(`drain`, drainCallback)\n\n    jobs.forEach(job =>\n      queue.push({\n        job,\n        activity,\n      })\n    )\n  })\n}\n\nmodule.exports = {\n  createBuildQueue,\n  createDevelopQueue,\n  processBatch,\n}\n"],"file":"queue.js"}